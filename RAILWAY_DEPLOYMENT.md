# Railway Deployment Guide

Complete guide for deploying AIQ to Railway.app (simpler AWS alternative for MVP).

## Overview

Railway will host three services:
1. **Backend Service** - FastAPI application
2. **PostgreSQL Database** - Managed database
3. **Cron Service** - Question generation (runs daily at 2 AM UTC)

**Expected Monthly Cost**: $10-20 (or $0-5 with free tier credits)

---

## Prerequisites

1. GitHub account with AIQ repository
2. Railway account (sign up at https://railway.app)
3. Railway CLI installed
4. At least one LLM API key (OpenAI, Anthropic, Google, or xAi)

---

## Part 1: Install Railway CLI

```bash
# macOS (Homebrew)
brew install railway

# Alternative: npm
npm i -g @railway/cli

# Verify installation
railway --version
```

---

## Part 2: Initial Setup via CLI

### Step 1: Login to Railway

```bash
# Login (will open browser)
railway login
```

### Step 2: Initialize Project

```bash
# Navigate to your repo
cd /Users/mattgioe/aiq

# Initialize Railway project
railway init
# This will prompt you to either:
# - Create a new project
# - Link to an existing project

# Choose "Create new project" and give it a name (e.g., "aiq-production")
```

### Step 3: Link GitHub Repository

```bash
# Link your GitHub repo (for auto-deployments)
railway link

# Alternative: You can do this in the Railway dashboard later
```

---

## Part 3: Create Services via Railway Dashboard

**Note**: While most operations can be done via CLI, creating services is easier via the dashboard for initial setup.

### Step 1: Open Project in Browser

```bash
railway open
```

### Step 2: Add PostgreSQL Database

1. Click **"+ New"** â†’ **"Database"** â†’ **"Add PostgreSQL"**
2. Railway will automatically provision the database
3. Note: The `DATABASE_URL` environment variable will be auto-generated

### Step 3: Add Backend Service

1. Click **"+ New"** â†’ **"GitHub Repo"**
2. Select your `aiq` repository
3. Configure the service:
   - **Name**: `backend`
   - **Root Directory**: `/` (leave default, we handle it in start command)
   - **Start Command**: Will use `railway.json` configuration

### Step 4: Add Cron Service

1. Click **"+ New"** â†’ **"GitHub Repo"**
2. Select your `aiq` repository again
3. Configure the service:
   - **Name**: `question-generation-cron`
   - **Root Directory**: `/` (leave default)
   - **Builder**: Nixpacks
   - **Cron Schedule**: `0 2 * * *` (daily at 2 AM UTC)

---

## Part 4: Configure Environment Variables

### Backend Service Variables

In Railway dashboard, go to **Backend Service** â†’ **Variables** tab:

```bash
# Required - Auto-generated by Railway
DATABASE_URL=${{Postgres.DATABASE_URL}}

# Generate these using Railway's "Generate" button
SECRET_KEY=<click-generate>
JWT_SECRET_KEY=<click-generate>

# Set these manually
ENV=production
APP_NAME=AIQ API
APP_VERSION=1.0.0
JWT_ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30
REFRESH_TOKEN_EXPIRE_DAYS=7
CORS_ORIGINS=*
RATE_LIMIT_ENABLED=true
RATE_LIMIT_STRATEGY=token_bucket
ADMIN_ENABLED=true
ADMIN_USERNAME=<your-admin-username>
ADMIN_PASSWORD=<your-admin-password>
LOG_LEVEL=INFO
```

**Tip**: You can use the Railway CLI to set variables:

```bash
# Switch to backend service
railway service backend

# Set variables
railway variables set ENV=production
railway variables set APP_NAME="AIQ API"
railway variables set ADMIN_USERNAME=admin
railway variables set ADMIN_PASSWORD=<secure-password>
# etc...
```

### Cron Service Variables

In Railway dashboard, go to **Cron Service** â†’ **Variables** tab:

```bash
# Database connection (same as backend)
DATABASE_URL=${{Postgres.DATABASE_URL}}

# LLM API Keys (set at least ONE)
OPENAI_API_KEY=<your-openai-key>
ANTHROPIC_API_KEY=<your-anthropic-key>
GOOGLE_API_KEY=<your-google-key>
XAI_API_KEY=<your-xai-key>

# Generation settings
QUESTIONS_PER_RUN=50
MIN_ARBITER_SCORE=0.7
ARBITER_CONFIG_PATH=./config/arbiters.yaml
LOG_LEVEL=INFO
LOG_FILE=./logs/generation.log

# Email alerts (optional - set to false if not using)
ENABLE_EMAIL_ALERTS=false
```

**Reference**: See `.env.railway.template` for complete list with descriptions.

---

## Part 5: Configure Service Settings

### Backend Service Configuration

1. Go to **Backend Service** â†’ **Settings**
2. Set **Root Directory**: (leave empty)
3. Set **Build Command**: (will use `railway.json`)
4. Set **Start Command**: (will use `railway.json`)
5. Set **Health Check Path**: `/health`
6. Set **Restart Policy**: `On Failure`

Railway will use the configuration from `railway.json`:
- Runs migrations: `alembic upgrade head`
- Starts server: `gunicorn` with uvicorn workers

### Cron Service Configuration

1. Go to **Cron Service** â†’ **Settings**
2. Enable **Cron Job** toggle
3. Set **Cron Schedule**: `0 2 * * *`
4. Set **Start Command**: (will use `railway-cron.json`)
5. Set **Restart Policy**: `Never` (cron jobs shouldn't restart)

Railway will use the configuration from `railway-cron.json`:
- Runs: `python run_generation.py --count 50 --verbose`

---

## Part 6: Deploy

### Option 1: Auto-Deploy on Git Push (Recommended)

Once configured, Railway will automatically deploy when you push to your main branch:

```bash
git push origin main
```

### Option 2: Manual Deploy via CLI

```bash
# Deploy backend service
railway service backend
railway up

# Deploy cron service
railway service question-generation-cron
railway up
```

### Option 3: Manual Deploy via Dashboard

1. Go to service in Railway dashboard
2. Click **"Deploy"** button
3. Select commit to deploy

---

## Part 7: Run Database Migrations

After first deployment, verify migrations ran:

```bash
# Connect to backend service
railway service backend

# Check migration status
railway run alembic current

# If migrations didn't run automatically, run manually:
railway run alembic upgrade head
```

---

## Part 8: Verify Deployment

### Check Backend Health

```bash
# Get backend URL
railway service backend
railway domain

# Test health endpoint
curl https://your-backend.railway.app/health
```

### Check Database Connection

```bash
# Connect to PostgreSQL via Railway CLI
railway connect postgres

# Verify tables exist
\dt

# Exit
\q
```

### View Logs

```bash
# Backend logs
railway service backend
railway logs

# Cron logs
railway service question-generation-cron
railway logs
```

### Test API Endpoints

```bash
# Get your backend URL
export API_URL=$(railway service backend && railway domain)

# Test root endpoint
curl https://$API_URL/

# Test API docs
open https://$API_URL/v1/docs
```

---

## Part 9: Monitor Cron Job

### View Cron Execution

1. Go to **Cron Service** in Railway dashboard
2. Check **Deployments** tab for execution history
3. View logs for each run

### Manual Cron Trigger (Testing)

```bash
# Switch to cron service
railway service question-generation-cron

# Run the script manually
railway run python question-service/run_generation.py --count 10 --verbose
```

---

## Part 10: Update iOS App Configuration

Update your iOS app to use the Railway backend URL:

1. Get your backend URL:
   ```bash
   railway service backend
   railway domain
   ```

2. Update `ios/AIQ/Utilities/Helpers/AppConfig.swift`:
   ```swift
   static let baseURL = "https://your-backend.railway.app/v1"
   ```

3. Rebuild and test iOS app

---

## Cost Management

### Free Tier

- **$5 free credit per month**
- Services sleep after 30 minutes of inactivity
- Good for development/testing

### Paid Tier (Recommended for Production)

- **$5/month minimum + usage**
- No sleeping
- Estimated $10-20/month total for AIQ

### Monitor Usage

```bash
# View current usage
railway status

# Check in dashboard: Project â†’ Usage tab
```

### Cost-Saving Tips

1. **Start with free tier** for testing
2. **Upgrade only backend** to paid (keep cron on free)
3. **Run cron less frequently** during testing (e.g., daily instead of hourly)
4. **Monitor logs** for errors that cause unnecessary runs

---

## Common Operations

### View Environment Variables

```bash
railway service backend
railway variables
```

### Update Environment Variable

```bash
railway variables set KEY=value
```

### Restart Service

```bash
railway service backend
railway restart
```

### Rollback Deployment

1. Go to service in dashboard
2. Click **Deployments** tab
3. Select previous deployment
4. Click **Redeploy**

### Connect to Database

```bash
railway connect postgres
```

### Run Commands with Production Env

```bash
# Example: Run migrations locally with production DATABASE_URL
railway run alembic upgrade head

# Example: Test cron script with production config
railway run python question-service/run_generation.py --dry-run
```

---

## Troubleshooting

### Backend Won't Start

**Check logs**:
```bash
railway service backend
railway logs
```

**Common issues**:
- Missing environment variables
- Database migration failed
- Port binding issues (Railway provides `$PORT`)

### Cron Job Not Running

**Check schedule**:
1. Dashboard â†’ Cron Service â†’ Settings
2. Verify **Cron Job** toggle is enabled
3. Verify schedule: `0 2 * * *`

**Check execution logs**:
```bash
railway service question-generation-cron
railway logs
```

### Database Connection Failed

**Verify DATABASE_URL is set**:
```bash
railway service backend
railway variables | grep DATABASE_URL
```

**Test connection**:
```bash
railway connect postgres
```

### Migrations Not Applied

**Manually run migrations**:
```bash
railway service backend
railway run alembic upgrade head
```

### High Usage/Costs

**Check metrics**:
1. Dashboard â†’ Project â†’ Usage tab
2. Identify which service is consuming resources

**Reduce costs**:
- Scale down to free tier for testing
- Reduce cron frequency
- Optimize database queries

---

## Next Steps

1. âœ… Deploy backend, database, and cron to Railway
2. âœ… Verify all services are running
3. âœ… Update iOS app with production backend URL
4. âœ… Test end-to-end flow (registration, test-taking, results)
5. âœ… Monitor cron job executions
6. âœ… Set up monitoring/alerts (optional)
7. ðŸš€ Launch to TestFlight

---

## Additional Resources

- **Railway Documentation**: https://docs.railway.app
- **Railway CLI Reference**: https://docs.railway.app/develop/cli
- **Railway Pricing**: https://railway.app/pricing
- **AIQ Project Files**:
  - `railway.json` - Backend service configuration
  - `railway-cron.json` - Cron service configuration
  - `.env.railway.template` - Environment variables reference
